{% extends 'Guest/base.html' %} {% load static %} {% block content %}
<!-- Load SweetAlert2 early to ensure it's available for inline scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- credits to the writter @leonam-silva-de-souza -->
<br /><br /><br /><br />
<div class="login-register-page">
  <div class="container">
    <div class="form-box login">
      <form id="login-form" action="" method="post">
        {% csrf_token %}
        <h1>Login</h1>
        <br />

        <div class="input-box">
          {{ login_form.username }}
          <i class="bx bxs-user"></i>
        </div>
        <div class="input-box">{{ login_form.password }}</div>
        <div class="forgot-link">
          <a href="{% url 'forgot_password_request' %}">Forgot Password?</a>
        </div>
        <button
          type="submit"
          class="btn"
          name="form_type"
          value="login"
          id="login-submit-btn"
        >
          Login
        </button>
        <!-- <p>or login with social platforms</p>
                  <div class="social-icons">
                      <a href="#"><i class='bx bxl-google' ></i></a>
                      <a href="#"><i class='bx bxl-facebook' ></i></a>
                      <a href="#"><i class='bx bxl-github' ></i></a>
                      <a href="#"><i class='bx bxl-linkedin' ></i></a>
                  </div> -->
      </form>
    </div>

    <div class="form-box register">
      <form
        id="register-form"
        action="{% url 'signup' %}"
        method="post"
        enctype="multipart/form-data"
        novalidate
      >
        {% csrf_token %}
        <div class="role-select-box" style="margin-bottom: 15px">
          <h1>Registration</h1>
          <div class="input-box">
            {{ user_form.role }}
            <i class="bx bxs-user-circle"></i>
          </div>
        </div>

        <!-- Step 1: Basic Information -->
        <div class="register-step step-1 active">
          <!-- Role-specific name fields -->
          <div class="role-fields role-farmer">
            <div class="input-box" style="margin-bottom: 10px">
              {{ farmer_form.farmer_name }}
              <i class="bx bxs-user"></i>
            </div>
          </div>

          <div class="role-fields role-collector" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ collector_form.collector_name }}
              <i class="bx bxs-user"></i>
            </div>
          </div>

          <div class="role-fields role-compost_manager" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ compost_form.compostmanager_name }}
              <i class="bx bxs-user"></i>
            </div>
          </div>

          <div class="role-fields role-household" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ household_form.household_name }}
              <i class="bx bxs-user"></i>
            </div>
          </div>

          <!-- Email -->
          <div class="input-box" style="margin-bottom: 10px">
            {{ user_form.email }}
            <i class="bx bxs-envelope"></i>
          </div>

          <button
            type="button"
            class="btn next-step"
            style="width: 100%; margin-top: 10px"
          >
            Next
          </button>
        </div>
        <!-- Step 2: Security & Contact -->
        <div class="register-step step-2">
          <!-- Password fields -->
          <div class="input-box" style="margin-bottom: 10px">
            {{ user_form.password1 }}
          </div>

          <div class="input-box" style="margin-bottom: 10px">
            {{ user_form.password2 }}
          </div>

          <!-- Phone field -->
          <div class="input-box" style="margin-bottom: 10px">
            {{ user_form.phone }}
            <i class="bx bxs-phone"></i>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button type="button" class="btn prev-step" style="flex: 1">
              Previous
            </button>
            <button type="button" class="btn next-step" style="flex: 1">
              Next
            </button>
          </div>
        </div>
        <!-- Step 3: Address Information -->
        <div class="register-step step-3">
          <!-- Role-specific address fields -->
          <div class="role-fields role-farmer">
            <div class="input-box" style="margin-bottom: 10px">
              {{ farmer_form.address }}
              <i class="bx bxs-home"></i>
            </div>
          </div>

          <div class="role-fields role-collector" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ collector_form.address }}
              <i class="bx bxs-home"></i>
            </div>
          </div>

          <div class="role-fields role-compost_manager" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ compost_form.address }}
              <i class="bx bxs-home"></i>
            </div>
          </div>

          <div class="role-fields role-household" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ household_form.address }}
              <i class="bx bxs-home"></i>
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button type="button" class="btn prev-step" style="flex: 1">
              Previous
            </button>
            <button type="button" class="btn next-step" style="flex: 1">
              Next
            </button>
          </div>
        </div>
        <!-- Step 4: Additional Information -->
        <div class="register-step step-4">
          <!-- Farmer Additional Fields -->
          <div class="role-fields role-farmer">
            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >Aadhar Image</label
              >
              {{ farmer_form.aadhaar_image }}
              <i class="bx bxs-file-image"></i>
            </div>
          </div>

          <!-- Collector Additional Fields -->
          <div class="role-fields role-collector" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >License Image</label
              >
              {{ collector_form.license_image }}
              <i class="bx bxs-file-image"></i>
            </div>
          </div>

          <!-- Compost Manager Additional Fields -->
          <div class="role-fields role-compost_manager" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              {{ compost_form.license_number }}
              <i class="bx bxs-id-card"></i>
            </div>
          </div>

          <!-- Household Additional Fields (Split Part 1) -->
          <div class="role-fields role-household" style="display: none">
            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >District</label
              >
              {{ household_form.district }}
              <i class="bx bxs-map"></i>
            </div>

            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >Location</label
              >
              {{ household_form.location }}
              <i class="bx bxs-location-plus"></i>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px">
              <button type="button" class="btn prev-step" style="flex: 1">
                Previous
              </button>
              <button type="button" class="btn next-step" style="flex: 1">
                Next
              </button>
            </div>
          </div>

          <!-- Different buttons for different roles (Non-Household finish here) -->
          <div
            class="role-fields role-farmer role-collector role-compost_manager"
          >
            <div style="display: flex; gap: 10px; margin-top: 20px">
              <button type="button" class="btn prev-step" style="flex: 1">
                Previous
              </button>
              <button
                type="submit"
                class="btn"
                name="form_type"
                value="register"
                style="
                  flex: 1;
                  background: linear-gradient(45deg, #4caf50, #45a049);
                "
              >
                Complete Registration
              </button>
            </div>
          </div>
        </div>

        <!-- Step 5: Household Additional Info Part 2 -->
        <div class="register-step step-5" style="display: none">
          <div class="role-fields role-household">
            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >Residents Association</label
              >
              {{ household_form.residents_association }}
              <i class="bx bxs-group"></i>
            </div>

            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >House No</label
              >
              {{ household_form.house_no }}
              <i class="bx bxs-home"></i>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px">
              <button type="button" class="btn prev-step" style="flex: 1">
                Previous
              </button>
              <button type="button" class="btn next-step" style="flex: 1">
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Step 6: Document Upload (Household Only) -->
        <div class="register-step step-6" style="display: none">
          <!-- Only show for household users -->
          <div class="role-fields role-household">
            <div class="input-box" style="margin-bottom: 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  color: #666;
                  font-weight: 500;
                "
                >Aadhar Image</label
              >
              {{ household_form.aadhaar_image }}
              <i class="bx bxs-file-image"></i>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px">
              <button type="button" class="btn prev-step" style="flex: 1">
                Previous
              </button>
              <button
                type="submit"
                class="btn"
                name="form_type"
                value="register"
                style="
                  flex: 1;
                  background: linear-gradient(45deg, #4caf50, #45a049);
                "
              >
                Complete Registration
              </button>
            </div>
          </div>
        </div>

        <!-- <p>or register with social platforms</p>
                  <div class="social-icons">
                      <a href="#"><i class='bx bxl-google' ></i></a>
                      <a href="#"><i class='bx bxl-facebook' ></i></a>
                      <a href="#"><i class='bx bxl-github' ></i></a>
                      <a href="#"><i class='bx bxl-linkedin' ></i></a>
                  </div> -->
      </form>
      <script>
        // Multi-step registration form logic with role selection
        (function () {
          const regForm = document.getElementById("register-form");
          if (!regForm) return;
          const steps = regForm.querySelectorAll(".register-step");
          const nextBtn = regForm.querySelector(".next-step");
          const prevBtn = regForm.querySelector(".prev-step");
          const roleSelect = regForm.querySelector("#id_role"); // Django form field ID
          const roleFields = regForm.querySelectorAll(".role-fields");

          let currentStepIndex = 0;
          let maxSteps = 4; // Default for farmer, collector, compost

          function updateMaxSteps(role) {
            if (role === "household") {
              maxSteps = 6;
              // Ensure step 5 and 6 are generally available to be shown
            } else {
              maxSteps = 4;
            }
          }

          function showStep(idx) {
            steps.forEach((step, i) => {
              if (i === idx) {
                step.classList.add("active");
                step.style.display = "block";
              } else {
                step.classList.remove("active");
                step.style.display = "none";
              }
            });
            currentStepIndex = idx;
          }

          function showRoleFields(role) {
            console.log("Showing fields for role:", role); // Debug log
            roleFields.forEach((fields) => {
              // Check if this field group should be shown
              const shouldShow =
                fields.classList.contains("role-" + role) ||
                fields.className.includes("role-" + role);

              if (shouldShow) {
                fields.style.display = "";
              } else {
                fields.style.display = "none";
              }
            });
            updateMaxSteps(role);
          }

          if (roleSelect) {
            roleSelect.addEventListener("change", function () {
              showRoleFields(this.value);
            });
            // Show default role fields on load
            if (roleSelect.value) {
              showRoleFields(roleSelect.value);
            }
          }

          if (nextBtn) {
            document.querySelectorAll(".next-step").forEach((btn) => {
              btn.addEventListener("click", function () {
                if (currentStepIndex < maxSteps - 1) {
                  showStep(currentStepIndex + 1);
                }
              });
            });
          }

          if (prevBtn) {
            document.querySelectorAll(".prev-step").forEach((btn) => {
              btn.addEventListener("click", function () {
                if (currentStepIndex > 0) {
                  showStep(currentStepIndex - 1);
                }
              });
            });
          }

          // Ensure first step is visible on load
          showStep(0);

          // Initialize role fields on page load - wait for DOM to be ready
          setTimeout(() => {
            if (roleSelect && roleSelect.value) {
              showRoleFields(roleSelect.value);
            } else {
              // Default to farmer if no role selected
              showRoleFields("farmer");
            }
          }, 100);
        })();
      </script>
    </div>

    <div class="toggle-box">
      <div class="toggle-panel toggle-left">
        <h1>Hello, Welcome!</h1>
        <p>Don't have an account?</p>
        <button class="btn register-btn">Register</button>
      </div>

      <div class="toggle-panel toggle-right">
        <h1>Welcome Back!</h1>
        <p>Already have an account?</p>
        <button class="btn login-btn">Login</button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles for Attractive Loader -->
<style>
  /* Animated popup entrance */
  .animated-popup {
    animation: popupFadeIn 0.3s ease-out !important;
    border-radius: 20px !important;
    box-shadow: 0 10px 40px rgba(108, 154, 46, 0.3) !important;
  }

  @keyframes popupFadeIn {
    from {
      opacity: 0;
      transform: scale(0.8) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Animated title with pulse effect */
  .animated-title {
    animation: titlePulse 2s ease-in-out infinite !important;
  }

  @keyframes titlePulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.8;
    }
  }

  /* Custom loader spinner styling */
  .swal2-loader {
    border-width: 4px !important;
    width: 50px !important;
    height: 50px !important;
    animation:
      spin 1s linear infinite,
      colorShift 3s ease-in-out infinite !important;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes colorShift {
    0%,
    100% {
      filter: brightness(1);
    }
    50% {
      filter: brightness(1.2);
    }
  }

  /* Add shimmer effect to the popup */
  .animated-popup::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(108, 154, 46, 0.1),
      transparent
    );
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% {
      left: -100%;
    }
    100% {
      left: 100%;
    }
  }
</style>

<!-- SweetAlert for Admin Login Success -->
<script>
  // Show loader on form submit (not button click) so it doesn't block submission
  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("login-form");

    if (loginForm) {
      loginForm.addEventListener("submit", function (e) {
        // Form will submit - just show the loader
        Swal.fire({
          title: '<strong style="color: #2d5016;">Logging You In</strong>',
          html: '<div style="color: #555; font-size: 16px; margin-top: 10px;">ðŸš€ Preparing your dashboard...</div>',
          allowOutsideClick: false,
          allowEscapeKey: false,
          showConfirmButton: false,
          background: "#fff",
          backdrop: "rgba(0,0,0,0.4)",
          customClass: {
            popup: "animated-popup",
            title: "animated-title",
          },
          didOpen: () => {
            Swal.showLoading();
            const loader =
              Swal.getHtmlContainer().querySelector(".swal2-loader");
            if (loader) {
              loader.style.borderColor = "#6c9a2e";
              loader.style.borderRightColor = "transparent";
            }
          },
        });
      });
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    const container = document.querySelector(".container");
    const registerBtn = document.querySelector(".register-btn");
    const loginBtn = document.querySelector(".login-btn");

    if (registerBtn && loginBtn && container) {
      registerBtn.addEventListener("click", () => {
        container.classList.add("active");
      });

      loginBtn.addEventListener("click", () => {
        container.classList.remove("active");
      });
    }

    // Check if we should show register form
    const showRegister = document.body.dataset.showRegister === "true";
    if (showRegister && container) {
      container.classList.add("active");
    }

    // Handle messages
    const messageData = document.body.dataset.messageData;
    if (messageData) {
      const messages = JSON.parse(messageData);
      messages.forEach((msg) => {
        console.log("Message found:", msg.message, "Tags:", msg.tags);

        if (msg.message === "admin_login_success") {
          console.log("Showing admin success alert");
          Swal.fire({
            title: "Welcome Admin!",
            text: "You have successfully logged in as Administrator",
            icon: "success",
            confirmButtonText: "Continue to Dashboard",
            confirmButtonColor: "#6366f1",
            background: "#fff",
            allowOutsideClick: false,
            allowEscapeKey: false,
            timer: null,
            showClass: {
              popup: "animate__animated animate__fadeInUp",
            },
            hideClass: {
              popup: "animate__animated animate__fadeOutDown",
            },
          }).then((result) => {
            console.log("SweetAlert closed, redirecting...");
            window.location.href = msg.adminUrl;
          });
        } else if (msg.message === "signup_success") {
          // Close any loading alert first
          Swal.close();
          Swal.fire({
            title: "Registration Successful!",
            text: "Your account has been created successfully. Please login to continue.",
            icon: "success",
            confirmButtonText: "OK",
            confirmButtonColor: "#4CAF50",
          });
        } else if (msg.message === "account_not_verified") {
          // Close loading alert only - let form show the message
          Swal.close();
        } else if (msg.message === "logout_success") {
          Swal.fire({
            title: "Logged Out Successfully",
            text: "You have been logged out. See you again soon!",
            icon: "success",
            confirmButtonText: "OK",
            confirmButtonColor: "#6c9a2e",
            iconColor: "#6c9a2e",
          });
        } else if (msg.tags === "error") {
          // Show error alert after a brief delay to ensure loader is closed
          console.log("Login error - showing alert");
          setTimeout(() => {
            Swal.fire({
              title: "Login Failed!",
              text: msg.message,
              icon: "error",
              confirmButtonText: "Try Again",
              confirmButtonColor: "#ef4444",
              customClass: {
                popup: "animated-popup",
              },
              showClass: {
                popup: "animate__animated animate__shakeX",
              },
            });
          }, 100);
        }
      });
    } else {
      console.log("No messages found");
    }

    // Initialize password toggles after DOM is ready
    setTimeout(() => {
      if (window.bioBinValidation) {
        window.bioBinValidation.setupPasswordToggle();
      }
    }, 500);
  });
</script>

<!-- Django template data passed via hidden elements (no IDE errors!) -->
{% if show_register %}
<div id="show-register-flag" style="display: none" data-value="true"></div>
{% endif %} {% if messages %}
<div id="messages-data" style="display: none">
  {% for message in messages %}
  <div
    class="message-item"
    data-message="{{ message.message|escapejs }}"
    data-tags="{{ message.tags|escapejs }}"
    data-admin-url="{% url 'admin_index' %}"
  ></div>
  {% endfor %}
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script id="messages-data" type="application/json">
  [
    {% for message in messages %}
      {
        "message": "{{ message.message|escapejs }}",
        "tags": "{{ message.tags|default:'' }}"
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
</script>

<script>
  // Check for messages on page load
  const messagesDataElement = document.getElementById("messages-data");
  if (messagesDataElement) {
    try {
      const messages = JSON.parse(messagesDataElement.textContent);

      const hasErrorMessages = messages.some((m) => m.tags.includes("error"));
      const hasSuccessMessages = messages.some((m) =>
        m.tags.includes("success"),
      );

      const errorMessage = messages
        .filter((m) => m.tags.includes("error"))
        .map((m) => m.message)
        .join(" ");
      const successMessage = messages
        .filter((m) => m.tags.includes("success"))
        .map((m) => m.message)
        .join(" ");

      if (hasErrorMessages) {
        if (typeof Swal !== "undefined") {
          Swal.close();
          setTimeout(() => {
            Swal.fire({
              title: "Login Failed!",
              text: errorMessage,
              icon: "error",
              confirmButtonText: "Try Again",
              confirmButtonColor: "#ef4444",
            });
          }, 100);
        }
      } else if (hasSuccessMessages) {
        if (typeof Swal !== "undefined") {
          Swal.close();
          setTimeout(() => {
            Swal.fire({
              title: "Success!",
              text: successMessage,
              icon: "success",
              confirmButtonText: "Continue",
              confirmButtonColor: "#10b981",
              timer: 5000,
              timerProgressBar: true,
            });
          }, 100);
        }
      } else {
        // Just close the loader if no messages
        if (typeof Swal !== "undefined") {
          Swal.close();
        }
      }
    } catch (e) {
      console.error("Error parsing messages JSON:", e);
    }
  }

  // Read data from hidden HTML elements
  document.addEventListener("DOMContentLoaded", function () {
    // Check for show register flag
    const showRegisterFlag = document.getElementById("show-register-flag");
    if (showRegisterFlag) {
      document.body.dataset.showRegister = showRegisterFlag.dataset.value;
    }
  });
</script>

{% endblock %}
