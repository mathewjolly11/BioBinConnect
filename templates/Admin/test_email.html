{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Configuration Test - BioBinConnect</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .test-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 100%;
      }
      .test-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .test-header h1 {
        color: #667eea;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .config-info {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 5px;
      }
      .config-info p {
        margin: 5px 0;
        font-size: 14px;
      }
      .btn-test {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        font-weight: 600;
        width: 100%;
        transition: transform 0.2s;
      }
      .btn-test:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .spinner-border {
        display: none;
      }
      .loading .spinner-border {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <div class="test-header">
        <h1>üìß Email Test</h1>
        <p class="text-muted">Test your Gmail SMTP configuration</p>
      </div>

      <div class="config-info">
        <p><strong>üìÆ Email Backend:</strong> {{ email_backend }}</p>
        <p><strong>üë§ Sender Email:</strong> {{ email_host_user }}</p>
        <p>
          <strong>üîê Status:</strong>
          <span class="badge bg-warning">Testing Required</span>
        </p>
      </div>

      <form id="testEmailForm">
        <div class="mb-3">
          <label for="recipientEmail" class="form-label"
            >Recipient Email Address</label
          >
          <input
            type="email"
            class="form-control"
            id="recipientEmail"
            name="recipient_email"
            placeholder="Enter email to send test message"
            required
          />
          <div class="form-text">
            Enter any email address to test (can be your own)
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-test">
          <span class="button-text">Send Test Email</span>
          <span
            class="spinner-border spinner-border-sm ms-2"
            role="status"
          ></span>
        </button>
      </form>

      <div class="mt-3 text-center">
        <a href="{% url 'admin_index' %}" class="btn btn-link"
          >‚Üê Back to Dashboard</a
        >
      </div>
    </div>

    <script>
      document
        .getElementById("testEmailForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const form = e.target;
          const button = form.querySelector('button[type="submit"]');
          const recipientEmail =
            document.getElementById("recipientEmail").value;

          // Show loading state
          button.classList.add("loading");
          button.disabled = true;

          try {
            const formData = new FormData(form);
            const response = await fetch('{% url "test_email" %}', {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (data.success) {
              Swal.fire({
                icon: "success",
                title: "Email Sent! ‚úÖ",
                html: `
                            <p>Test email sent successfully to:</p>
                            <strong>${recipientEmail}</strong>
                            <p class="mt-3">Check the inbox (and spam folder) of this email address.</p>
                        `,
                confirmButtonColor: "#667eea",
              });
              form.reset();
            } else {
              Swal.fire({
                icon: "error",
                title: "Email Failed ‚ùå",
                html: `
                            <p><strong>Error:</strong></p>
                            <pre style="text-align: left; background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;">${data.error}</pre>
                            <p class="mt-3"><strong>Common Issues:</strong></p>
                            <ul style="text-align: left; font-size: 14px;">
                                <li>Error 535: Wrong App Password or 2-Step Verification not enabled</li>
                                <li>Error 534: 2-Step Verification required</li>
                                <li>Check your .env file has correct credentials</li>
                                <li>Restart Django server after changing .env</li>
                            </ul>
                        `,
                confirmButtonColor: "#dc3545",
              });
            }
          } catch (error) {
            Swal.fire({
              icon: "error",
              title: "Request Failed",
              text: "Could not send test email. Check console for details.",
              confirmButtonColor: "#dc3545",
            });
            console.error("Error:", error);
          } finally {
            // Remove loading state
            button.classList.remove("loading");
            button.disabled = false;
          }
        });
    </script>
  </body>
</html>
