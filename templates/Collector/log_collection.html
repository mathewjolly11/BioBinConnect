{% extends 'Collector/base.html' %} {% load static %} {% block content %}
<section id="section-hero" class="no-bottom" aria-label="section">
  <div class="d-flex align-items-center flex-col">
    <div class="col-md-8 text-center pt-50 pb-20">
      <h1 class="wow fadeInUp" data-wow-delay=".3s">Log Collection</h1>
      <p class="lead wow fadeInUp" data-wow-delay=".4s">
        Enter details for Pickup #{{ pickup.Pickup_id }}
      </p>
    </div>
  </div>
</section>

<section id="section-content" class="no-top">
  <div class="container">
    <div class="row">
      <div class="col-md-6 offset-md-3">
        <div class="de_testi bg-white p-5 wow fadeInUp rounded shadow-sm">
          <div class="mb-4">
            <h5><i class="fa fa-home text-primary"></i> Household Details</h5>
            <div class="alert alert-info">
              <strong>Name:</strong> {{ pickup.household.household_name }}<br />
              <strong>Address:</strong> {{ pickup.household.address }}<br />
              <strong>House No:</strong> {{ pickup.household.house_no }}<br />
              <strong>Bin Type:</strong> {{ pickup.bin_type.name }}
              ({{pickup.bin_type.capacity_kg }} kg capacity)
            </div>
          </div>

          <form
            id="collectionForm"
            method="post"
            class="form-border"
            onsubmit="return false;"
          >
            {% csrf_token %}
            <div class="col-md-12">
              <label
                for="{{ form.total_quantity_kg.id_for_label }}"
                class="form-label"
                ><i class="fa fa-balance-scale text-success"></i> Total Waste
                Collected (Kg):</label
              >
              {{ form.total_quantity_kg }} {% if form.total_quantity_kg.errors
              %}
              <div class="text-danger small">
                {{ form.total_quantity_kg.errors.0 }}
              </div>
              {% endif %}

              <div class="form-text">
                <i class="fa fa-info-circle"></i> Please verify the weight
                before submitting. Default price: ₹{{ current_waste_price }}/kg
                will be applied for farmer purchases.
              </div>
            </div>

            <div class="col-md-12 text-center mt-4">
              <button
                type="button"
                id="submitBtn"
                class="btn-main"
                onclick="handleSubmit(event)"
              >
                <i class="fa fa-check-circle me-2"></i>Submit Collection Log
              </button>
              <a href="{% url 'view_assigned_pickups' %}" class="btn-line ms-2"
                ><i class="fa fa-arrow-left me-2"></i>Cancel</a
              >
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .collection-loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #6c9a2e;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .status-icon {
    font-size: 2rem;
    margin-bottom: 15px;
  }

  .email-status-item {
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 8px;
    border: 1px solid;
  }

  .email-status-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
  }

  .email-status-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
  }

  .email-status-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }
</style>

<script>
  let formSubmitted = false;

  function handleSubmit(event) {
    event.preventDefault();

    if (formSubmitted) {
      console.log("Form already submitted, ignoring");
      return false;
    }

    const weight = document.getElementById(
      "{{ form.total_quantity_kg.id_for_label }}",
    ).value;

    if (!weight || parseFloat(weight) <= 0) {
      Swal.fire({
        icon: "warning",
        title: "Invalid Weight",
        text: "Please enter a valid weight greater than 0 kg",
        confirmButtonColor: "#6c9a2e",
      });
      return false;
    }

    // Confirm before submission
    Swal.fire({
      title: "Confirm Collection",
      html: `
            <div class="text-center">
                <p><strong>Weight to log:</strong> ${weight} kg</p>
                <p><strong>Household:</strong> {{ pickup.household.household_name }}</p>
                <p><strong>Pickup ID:</strong> #{{ pickup.Pickup_id }}</p>
                <hr>
                  <small class="text-muted">This will complete the pickup and make the waste available for farmer purchase at ₹{{ current_waste_price }}/kg</small>
            </div>
        `,
      icon: "question",
      showCancelButton: true,
      confirmButtonText: '<i class="fa fa-check"></i> Yes, Log Collection',
      cancelButtonText: '<i class="fa fa-times"></i> Cancel',
      confirmButtonColor: "#6c9a2e",
      cancelButtonColor: "#6b7280",
    }).then((result) => {
      if (result.isConfirmed) {
        submitCollection();
      }
    });

    return false;
  }

  function submitCollection() {
    if (formSubmitted) return;
    formSubmitted = true;

    // Disable submit button
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.innerHTML =
      '<i class="fa fa-spinner fa-spin me-2"></i>Processing...';

    // Show processing loader
    Swal.fire({
      title: "Processing Collection Log...",
      html: `
              <div class="text-center">
                  <div class="collection-loader"></div>
                  <div id="process-status">
                      <p><i class="fa fa-database text-info"></i> Saving collection data...</p>
                  </div>
              </div>
          `,
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        // Prepare form data
        const formData = {
          total_quantity_kg: document.getElementById(
            "{{ form.total_quantity_kg.id_for_label }}",
          ).value,
        };

        // Update progress
        setTimeout(() => {
          document.getElementById("process-status").innerHTML = `
                      <p><i class="fa fa-check text-success"></i> Collection data saved!</p>
                      <p><i class="fa fa-warehouse text-info"></i> Creating waste inventory...</p>
                  `;
        }, 1000);

        // Submit via AJAX
        setTimeout(() => {
          fetch('{% url "log_collection_ajax" pickup.Pickup_id %}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]",
              ).value,
            },
            body: JSON.stringify(formData),
          })
            .then((response) => response.json())
            .then((data) => {
              // Update progress
              document.getElementById("process-status").innerHTML = `
                          <p><i class="fa fa-check text-success"></i> Waste inventory created!</p>
                          <p><i class="fa fa-envelope-o text-info"></i> Sending notification emails...</p>
                      `;

              setTimeout(() => {
                if (data.success) {
                  // Show detailed success message
                  showDetailedSuccessMessage(data);
                } else {
                  // Show error message
                  Swal.fire({
                    icon: "error",
                    title: "Collection Failed",
                    html: `
                                      <p>${data.message}</p>
                                      ${data.errors ? '<ul class="text-start">' + data.errors.map((err) => `<li>${err}</li>`).join("") + "</ul>" : ""}
                                  `,
                    confirmButtonColor: "#6c9a2e",
                  }).then(() => {
                    resetForm();
                  });
                }
              }, 1500);
            })
            .catch((error) => {
              console.error("Error:", error);
              Swal.fire({
                icon: "error",
                title: "Network Error",
                text: "Failed to submit collection log. Please check your internet connection.",
                confirmButtonColor: "#6c9a2e",
              }).then(() => {
                resetForm();
              });
            });
        }, 2000);
      },
    });
  }

  function showDetailedSuccessMessage(data) {
    const emailStatus = data.email_status;
    const collection = data.collection_data;

    let emailStatusHtml = "";
    let emailIcon = "success";

    // Check email sending status
    if (
      emailStatus.household_completion === true ||
      emailStatus.household_completion === "True"
    ) {
      emailStatusHtml +=
        '<div class="email-status-item email-status-success"><i class="fa fa-check-circle"></i> ✓ Completion email sent to household</div>';
    } else if (emailStatus.household_completion === "Skipped") {
      emailStatusHtml +=
        '<div class="email-status-item email-status-warning" style="background-color: #e2e3e5; border-color: #d6d8db; color: #383d41;"><i class="fa fa-ban"></i> ⊘ Email notifications disabled in settings</div>';
      // Don't change main icon to warning for this case, as it's an intentional setting
    } else {
      emailStatusHtml +=
        '<div class="email-status-item email-status-warning"><i class="fa fa-exclamation-triangle"></i> ⚠ Completion email failed to send</div>';
      emailIcon = "warning";
    }

    // Show any specific errors
    if (emailStatus.errors.length > 0) {
      emailStatusHtml +=
        '<div class="mt-3"><strong class="text-danger">Email Errors:</strong></div>';
      emailStatus.errors.forEach((error) => {
        emailStatusHtml += `<div class="email-status-item email-status-error"><i class="fa fa-times-circle"></i> ${error}</div>`;
      });
      emailIcon = "warning";
    }

    Swal.fire({
      icon: emailIcon,
      title: "Collection Logged Successfully!",
      html: `
              <div class="text-center">
                  <div class="status-icon">
                      <i class="fa fa-check-circle text-success"></i>
                  </div>
                  
                  <div class="alert alert-success mb-4">
                      <h5><i class="fa fa-balance-scale"></i> Collection Complete</h5>
                      <strong>Weight Collected:</strong> ${collection.weight} kg<br>
                      <strong>Collection ID:</strong> #${collection.collection_id}<br>
                      <strong>Date:</strong> ${collection.collection_date}<br>
                      <strong>Household:</strong> ${collection.household_name}
                  </div>
                  
                  <div class="alert alert-info mb-4">
                      <h6><i class="fa fa-shopping-cart"></i> Waste Inventory</h6>
                      <p>This waste is now available for farmer purchase at <strong>₹{{ current_waste_price }}/kg</strong></p>
                      <small>Inventory ID: #${collection.inventory_id}</small>
                  </div>
                  
                  <hr>
                  <h6><i class="fa fa-envelope"></i> Email Notifications:</h6>
                  <div class="mt-3">
                      ${emailStatusHtml}
                  </div>
              </div>
          `,
      confirmButtonColor: "#6c9a2e",
      confirmButtonText: '<i class="fa fa-list"></i> View My Pickups',
      width: "600px",
    }).then(() => {
      // Redirect to assigned pickups page
      window.location.href = '{% url "view_assigned_pickups" %}';
    });
  }

  function resetForm() {
    formSubmitted = false;
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = false;
    submitBtn.innerHTML =
      '<i class="fa fa-check-circle me-2"></i>Submit Collection Log';
  }
</script>

{% endblock %}
