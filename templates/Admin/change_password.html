{% extends "Admin/base.html" %}
{% load static %}

{% block content %}
{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
      {% for message in messages %}
      Swal.fire({
          icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" %}error{% else %}info{% endif %}',
          title: '{% if message.tags == "success" %}Success!{% elif message.tags == "error" %}Error!{% else %}Info{% endif %}',
          text: '{{ message }}',
          timer: 3000,
          showConfirmButton: true,
          confirmButtonColor: '#28a745'
      });
      {% endfor %}
  });
</script>
{% endif %}
<section id="main-content">
  <section class="wrapper main-wrapper">
    <div class="col-lg-12">
      <section class="box">
        <header class="panel_header">
          <h2 class="title text-center">Change Password</h2>
        </header>
        <div class="content-body">
          <div class="row">
            <div class="col-md-6 offset-md-3">
              <!-- User Information Card -->
              <div class="card mb-4">
                <div class="card-header bg-info text-white">
                  <h5 class="mb-0">
                    <i class="fa fa-user"></i> User Information
                  </h5>
                </div>
                <div class="card-body">
                  <div class="user-info">
                    <p><strong>Name:</strong> {{ user.name }}</p>
                    <p><strong>Email:</strong> {{ user.email }}</p>
                    <p>
                      <strong>Role:</strong>
                        class="badge 
                        {% if user.role == 'household' %}badge-primary
                        {% elif user.role == 'collector' %}badge-info
                        {% elif user.role == 'compost_manager' %}badge-success
                        {% elif user.role == 'farmer' %}badge-warning
                        {% endif %}"
                      >
                        {% if user.role == 'household' %}Household
                        {% elif user.role == 'collector' %}Collector
                        {% elif user.role == 'compost_manager' %}Compost Manager
                        {% elif user.role == 'farmer' %}Farmer
                        {% endif %}
                      </span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Password Change Form -->
              <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                  <h5 class="mb-0"><i class="fa fa-lock"></i> New Password</h5>
                </div>
                <div class="card-body">
                  <form
                    method="POST"
                    action="{% url 'change_user_password' user.id %}"
                    id="passwordForm"
                  >
                    {% csrf_token %}

                    <div class="form-group mb-3">
                      <label for="new_password"
                        >New Password <span class="text-danger">*</span></label
                      >
                      <div class="input-group">
                        <input
                          type="password"
                          class="form-control"
                          id="new_password"
                          name="new_password"
                          placeholder="Enter new password"
                          required
                          minlength="6"
                        />
                        <div class="input-group-append">
                          <button
                            class="btn btn-outline-secondary"
                            type="button"
                            id="togglePassword"
                          >
                            <i class="fa fa-eye" id="eyeIcon"></i>
                          </button>
                        </div>
                      </div>
                      <small class="form-text text-muted"
                        >Password must be at least 6 characters long</small
                      >
                    </div>

                    <div class="form-group mb-3">
                      <label for="confirm_password"
                        >Confirm Password
                        <span class="text-danger">*</span></label
                      >
                      <div class="input-group">
                        <input
                          type="password"
                          class="form-control"
                          id="confirm_password"
                          name="confirm_password"
                          placeholder="Re-enter new password"
                          required
                          minlength="6"
                        />
                        <div class="input-group-append">
                          <button
                            class="btn btn-outline-secondary"
                            type="button"
                            id="toggleConfirmPassword"
                          >
                            <i class="fa fa-eye" id="eyeIconConfirm"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="form-group mb-3">
                      <label>Password Strength:</label>
                      <div class="progress" style="height: 25px">
                        <div
                          class="progress-bar"
                          id="passwordStrength"
                          role="progressbar"
                          style="width: 0%"
                          aria-valuenow="0"
                          aria-valuemin="0"
                          aria-valuemax="100"
                        >
                          <span id="strengthText">-</span>
                        </div>
                      </div>
                    </div>

                    <div class="alert alert-warning" role="alert">
                      <i class="fa fa-exclamation-triangle"></i>
                      <strong>Warning:</strong> The user will need to use this
                      new password to login.
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-group text-center mt-4">
                      <a
                        href="{% url 'view_users' %}"
                        class="btn btn-secondary"
                      >
                        <i class="fa fa-times"></i> Cancel
                      </a>
                      <button type="submit" class="btn btn-warning text-white">
                        <i class="fa fa-key"></i> Change Password
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </section>
</section>

<script>
  // Toggle password visibility
  document
    .getElementById("togglePassword")
    .addEventListener("click", function () {
      const passwordInput = document.getElementById("new_password");
      const eyeIcon = document.getElementById("eyeIcon");

      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        eyeIcon.classList.remove("fa-eye");
        eyeIcon.classList.add("fa-eye-slash");
      } else {
        passwordInput.type = "password";
        eyeIcon.classList.remove("fa-eye-slash");
        eyeIcon.classList.add("fa-eye");
      }
    });

  document
    .getElementById("toggleConfirmPassword")
    .addEventListener("click", function () {
      const passwordInput = document.getElementById("confirm_password");
      const eyeIcon = document.getElementById("eyeIconConfirm");

      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        eyeIcon.classList.remove("fa-eye");
        eyeIcon.classList.add("fa-eye-slash");
      } else {
        passwordInput.type = "password";
        eyeIcon.classList.remove("fa-eye-slash");
        eyeIcon.classList.add("fa-eye");
      }
    });

  // Password strength indicator
  document
    .getElementById("new_password")
    .addEventListener("input", function () {
      const password = this.value;
      const strengthBar = document.getElementById("passwordStrength");
      const strengthText = document.getElementById("strengthText");

      let strength = 0;
      let text = "";
      let color = "";

      if (password.length >= 6) strength += 25;
      if (password.length >= 10) strength += 25;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
      if (/[0-9]/.test(password)) strength += 15;
      if (/[^a-zA-Z0-9]/.test(password)) strength += 10;

      if (strength < 25) {
        text = "Weak";
        color = "bg-danger";
      } else if (strength < 50) {
        text = "Fair";
        color = "bg-warning";
      } else if (strength < 75) {
        text = "Good";
        color = "bg-info";
      } else {
        text = "Strong";
        color = "bg-success";
      }

      strengthBar.style.width = strength + "%";
      strengthBar.className = "progress-bar " + color;
      strengthText.textContent = text;
    });

  // Form validation
  document
    .getElementById("passwordForm")
    .addEventListener("submit", function (e) {
      const newPassword = document.getElementById("new_password").value;
      const confirmPassword = document.getElementById("confirm_password").value;

      if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert("Passwords do not match! Please try again.");
        return false;
      }

      if (newPassword.length < 6) {
        e.preventDefault();
        alert("Password must be at least 6 characters long!");
        return false;
      }
    });
</script>

<style>
  .card {
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .card-header {
    border-radius: 8px 8px 0 0;
    padding: 15px;
  }

  .card-body {
    padding: 20px;
  }

  .user-info p {
    margin-bottom: 10px;
    font-size: 16px;
  }

  .form-group label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
  }

  .form-control {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 10px 12px;
  }

  .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .input-group-append .btn {
    border-radius: 0 6px 6px 0;
  }

  .btn {
    padding: 10px 24px;
    border-radius: 6px;
    font-weight: 600;
    margin: 0 5px;
  }

  .text-danger {
    color: #dc3545;
  }

  .badge {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
  }

  .progress {
    border-radius: 6px;
    overflow: hidden;
  }

  .progress-bar {
    transition: width 0.3s ease, background-color 0.3s ease;
    font-weight: 600;
  }

  .alert {
    border-radius: 6px;
    padding: 12px 15px;
  }
</style>
{% endblock %}
