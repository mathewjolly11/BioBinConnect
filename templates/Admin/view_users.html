{% extends "Admin/base.html" %} {% load static %} {% block content %}
<section id="main-content">
  <section class="wrapper main-wrapper">
    <div class="col-lg-12">
      <section class="box">
        <header class="panel_header">
          <h2 class="title text-center">User Verification</h2>
          <div class="text-center mb-3">
            <div class="col-md-6 text-end">
              <a href="?export=excel" class="btn btn-success text-white me-2">
                <i class="fa fa-file-excel-o"></i> Export List
              </a>
              <button
                onclick="confirmBulkAction('approve')"
                class="btn btn-success text-white me-2"
              >
                <i class="fa fa-check-circle"></i> Approve All
              </button>
              <button
                onclick="confirmBulkAction('reject')"
                class="btn btn-danger text-white"
              >
                <i class="fa fa-times-circle"></i> Reject All
              </button>
            </div>
          </div>
        </header>
        <div class="content-body">
          <div class="row">
            <div class="col-md-12">
              <table class="table table-bordered table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th>S.No</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for data in user_data %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ data.user.name }}</td>
                    <td>{{ data.user.email }}</td>
                    <td>{{ data.user.get_role_display }}</td>
                    <td>
                      {% if data.user.account_status == 'Approved' %}
                      <span class="badge badge-success">Approved</span>
                      {% elif data.user.account_status == 'Rejected' %}
                      <span class="badge badge-danger">Rejected</span>
                      {% else %}
                      <span class="badge badge-warning">Pending</span>
                      {% endif %}
                    </td>
                    <td>
                      <a
                        href="{% url 'edit_user' data.user.id %}"
                        class="btn btn-sm btn-primary mb-1"
                      >
                        <i class="fa fa-edit"></i> Edit
                      </a>
                      <a
                        href="#"
                        data-href="{% url 'change_user_password' data.user.id %}"
                        class="btn btn-sm btn-warning mb-1 swal-password"
                      >
                        <i class="fa fa-key"></i> Password
                      </a>
                      {% if data.user.account_status == 'Approved' %}
                      <a
                        href="#"
                        data-href="{% url 'reject_user' data.user.id %}"
                        class="btn btn-sm btn-danger swal-reject"
                      >
                        <i class="fa fa-times"></i> Revoke
                      </a>
                      {% elif data.user.account_status == 'Rejected' %}
                      <a
                        href="#"
                        data-href="{% url 'approve_user' data.user.id %}"
                        class="btn btn-sm btn-success swal-approve"
                      >
                        <i class="fa fa-check"></i> Approve
                      </a>
                      {% else %}
                      <a
                        href="#"
                        data-href="{% url 'approve_user' data.user.id %}"
                        class="btn btn-sm btn-success swal-approve mb-1"
                      >
                        <i class="fa fa-check"></i> Approve
                      </a>
                      <a
                        href="#"
                        data-href="{% url 'reject_user' data.user.id %}"
                        class="btn btn-sm btn-danger swal-reject mb-1"
                      >
                        <i class="fa fa-times"></i> Reject
                      </a>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </section>
</section>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".swal-approve").forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Approve User?",
          text: "This user will be able to login after approval.",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#28a745",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Yes, approve!",
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading alert while processing
            Swal.fire({
              title: "Processing...",
              html: "Approving user and sending email notification...",
              allowOutsideClick: false,
              allowEscapeKey: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            // Navigate to approval URL
            window.location.href = btn.getAttribute("data-href");
          }
        });
      });
    });

    document.querySelectorAll(".swal-reject").forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Revoke Verification?",
          text: "This user will not be able to login until re-approved.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ffc107",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Yes, revoke!",
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading alert while processing
            Swal.fire({
              title: "Processing...",
              html: "Revoking verification and sending email notification...",
              allowOutsideClick: false,
              allowEscapeKey: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            // Navigate to rejection URL
            window.location.href = btn.getAttribute("data-href");
          }
        });
      });
    });

    document.querySelectorAll(".swal-password").forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Change Password?",
          text: "You will be redirected to the password change page.",
          icon: "info",
          showCancelButton: true,
          confirmButtonColor: "#ffc107",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Yes, proceed!",
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = btn.getAttribute("data-href");
          }
        });
      });
    });

    // Batch Actions
    document
      .querySelector(".swal-approve-all")
      .addEventListener("click", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Approve ALL Pending?",
          text: "This will approve ALL pending users immediately.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#28a745",
          confirmButtonText: "Yes, Approve All!",
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = this.getAttribute("data-href");
          }
        });
      });

    document
      .querySelector(".swal-reject-all")
      .addEventListener("click", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Reject ALL Pending?",
          text: "This will reject ALL pending users immediately.",
          icon: "error",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          confirmButtonText: "Yes, Reject All!",
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = this.getAttribute("data-href");
          }
        });
      });
  });
</script>
{% endblock %}
