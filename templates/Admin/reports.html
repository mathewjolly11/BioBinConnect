{% extends 'Admin/base.html' %}
{% load static %}

{% block content %}
<section id="main-content">
    <section class="wrapper main-wrapper">

        <!-- Header -->
        <div class="row mb-4 align-items-center">
            <div class="col-md-8">
                <h2 style="font-weight: 700; color: #1F2937; margin-bottom: 8px;">üìä Reports & Analytics</h2>
                <p style="color: #6B7280; margin: 0;">Detailed financial and operational insights</p>
            </div>
            <div class="col-md-4 text-end">
                <form method="get" class="form-inline justify-content-end align-items-center d-flex gap-2" id="reportForm">
                    <div id="customDateRange" class="d-none d-flex gap-2 align-items-center">
                        <input type="date" name="start_date" value="{{ custom_start_date }}" class="form-control form-control-sm" placeholder="Start Date">
                        <span class="text-muted">-</span>
                        <input type="date" name="end_date" value="{{ custom_end_date }}" class="form-control form-control-sm" placeholder="End Date">
                        <button type="submit" class="btn btn-primary btn-sm">Go</button>
                    </div>
                    
                    <select name="period" class="form-select w-auto" id="periodSelect" onchange="toggleCustomDate()"
                        style="border-radius: 8px; font-weight: 600;">
                        <option value="7" {% if period == '7' %}selected{% endif %}>Last 7 Days</option>
                        <option value="30" {% if period == '30' %}selected{% endif %}>Last 30 Days</option>
                        <option value="90" {% if period == '90' %}selected{% endif %}>Last 90 Days</option>
                        <option value="all" {% if period == 'all' %}selected{% endif %}>All Time</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                </form>
                
                <script>
                    function toggleCustomDate(shouldSubmit) {
                        var select = document.getElementById('periodSelect');
                        var customRange = document.getElementById('customDateRange');
                        var form = document.getElementById('reportForm');
                        
                        if (select.value === 'custom') {
                            customRange.classList.remove('d-none');
                        } else {
                            customRange.classList.add('d-none');
                            if (shouldSubmit) {
                                form.submit();
                            }
                        }
                    }
                    // Run on load to set initial state WITHOUT submitting
                    document.addEventListener('DOMContentLoaded', function() {
                        toggleCustomDate(false);
                    });
                </script>
            </div>
        </div>

        <!-- Profit Summary -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="dashboard-stat-card bg-success text-white">
                    <div style="font-size: 2.5rem; margin-bottom: 8px;">üíµ</div>
                    <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">&#8377;{{ total_revenue|floatformat:2 }}</div>
                    <p style="margin: 0; opacity: 0.9;">Total Revenue</p>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="dashboard-stat-card bg-danger text-white">
                    <div style="font-size: 2.5rem; margin-bottom: 8px;">üí∏</div>
                    <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">&#8377;{{ total_salary_expense|floatformat:2 }}</div>
                    <p style="margin: 0; opacity: 0.9;">Salary Expenses</p>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="dashboard-stat-card text-white {% if net_profit >= 0 %}bg-primary{% else %}bg-warning{% endif %}">
                    <div style="font-size: 2.5rem; margin-bottom: 8px;">üìà</div>
                    <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">&#8377;{{ net_profit|floatformat:2 }}</div>
                    <p style="margin: 0; opacity: 0.9;">Net Profit</p>
                </div>
            </div>
        </div>

        <!-- Visual Insights -->
        <h4 style="font-weight: 700; color: #1F2937; margin-bottom: 20px;">üìä Visual Insights</h4>
        <div class="row mb-4">
            <!-- Trend Chart -->
            <div class="col-md-6 mb-3">
                <div class="card h-100 shadow-sm border-0" style="border-radius: 12px;">
                    <div class="card-body">
                        <h5 class="card-title" style="font-weight: 700; color: #4B5563;">Financial Trend (6 Months)</h5>
                        <canvas id="trendChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
            <!-- Revenue Split -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 shadow-sm border-0" style="border-radius: 12px;">
                    <div class="card-body">
                        <h5 class="card-title text-center" style="font-weight: 700; color: #4B5563;">Revenue Sources</h5>
                        <div style="position: relative; height: 200px; display: flex; justify-content: center;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- User Demographics -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 shadow-sm border-0" style="border-radius: 12px;">
                    <div class="card-body">
                        <h5 class="card-title text-center" style="font-weight: 700; color: #4B5563;">User Distribution</h5>
                        <div style="position: relative; height: 200px; display: flex; justify-content: center;">
                            <canvas id="userChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // 1. Trend Chart (Bar)
                const ctxTrend = document.getElementById('trendChart').getContext('2d');
                new Chart(ctxTrend, {
                    type: 'bar',
                    data: {
                        labels: {{ trend_labels|safe }},
                        datasets: [
                            {
                                label: 'Revenue (‚Çπ)',
                                data: {{ trend_revenue|safe }},
                                backgroundColor: '#10B981',
                                borderRadius: 4
                            },
                            {
                                label: 'Expenses (‚Çπ)',
                                data: {{ trend_expense|safe }},
                                backgroundColor: '#EF4444',
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true, grid: { borderDash: [2, 2] } } }
                    }
                });

                // 2. Revenue Sources (Pie)
                const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctxRevenue, {
                    type: 'doughnut',
                    data: {
                        labels: ['Waste Sales', 'Compost Sales', 'Household Fees'],
                        datasets: [{
                            data: {{ chart_revenue_split|safe }},
                            backgroundColor: ['#3B82F6', '#F59E0B', '#6366F1'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
                    }
                });

                // 3. User Demographics (Donut)
                const ctxUser = document.getElementById('userChart').getContext('2d');
                new Chart(ctxUser, {
                    type: 'doughnut',
                    data: {
                        labels: ['Households', 'Farmers', 'Collectors'],
                        datasets: [{
                            data: {{ chart_user_data|safe }},
                            backgroundColor: ['#8B5CF6', '#10B981', '#EC4899'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
                    }
                });
            });
        </script>

        <!-- Revenue Overview -->
        <h4 style="font-weight: 700; color: #1F2937; margin-bottom: 20px;">üí∞ Revenue Breakdown</h4>
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; margin-bottom: 12px;">üåæ</div>
                        <h4 style="color: #6366F1; font-weight: 700;">&#8377;{{ waste_revenue|floatformat:2 }}</h4>
                        <p style="color: #6B7280; font-size: 0.9rem; margin: 0;">Waste Sales</p>
                        <span class="badge bg-secondary mt-2">{{ waste_orders_count }} orders</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; margin-bottom: 12px;">üçÇ</div>
                        <h4 style="color: #6366F1; font-weight: 700;">&#8377;{{ compost_revenue|floatformat:2 }}</h4>
                        <p style="color: #6B7280; font-size: 0.9rem; margin: 0;">Compost Sales</p>
                        <span class="badge bg-secondary mt-2">{{ compost_orders_count }} orders</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; margin-bottom: 12px;">üí≥</div>
                        <h4 style="color: #6366F1; font-weight: 700;">&#8377;{{ total_payment_amount|floatformat:2 }}
                        </h4>
                        <p style="color: #6B7280; font-size: 0.9rem; margin: 0;">Payment Transactions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Status -->
        <h4 style="font-weight: 700; color: #1F2937; margin-bottom: 20px;">üì¶ Live Inventory</h4>
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card" style="border: none; border-radius: 16px; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                    <div class="card-body" style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="
                                width: 56px;
                                height: 56px;
                                background: white;
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 2rem;
                                flex-shrink: 0;
                            ">
                                üåæ
                            </div>
                            <div style="flex: 1;">
                                <h3 style="font-weight: 800; color: #1F2937; margin: 0; font-size: 1.75rem;">
                                    {{ total_waste_stock|floatformat:2 }}
                                    <span style="font-size: 1rem; color: #9ca3af;">kg</span>
                                </h3>
                                <p style="margin: 0; color: #6B7280; font-size: 0.95rem;">Waste Stock</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card" style="border: none; border-radius: 16px; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                    <div class="card-body" style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="
                                width: 56px;
                                height: 56px;
                                background: white;
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 2rem;
                                flex-shrink: 0;
                            ">
                                üçÇ
                            </div>
                            <div style="flex: 1;">
                                <h3 style="font-weight: 800; color: #1F2937; margin: 0; font-size: 1.75rem;">
                                    {{ total_compost_stock|floatformat:0 }}
                                    <span style="font-size: 1rem; color: #9ca3af;">packets</span>
                                </h3>
                                <p style="margin: 0; color: #6B7280; font-size: 0.95rem;">Compost Stock</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manager Salaries Preview -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="font-weight: 700; color: #1F2937;">üíº Manager Salaries Preview</h4>
            <a href="{% url 'manager_salaries' %}" class="btn btn-primary btn-sm">View Full Details</a>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Manager Name</th>
                                <th>Days Worked</th>
                                <th>Daily Rate</th>
                                <th>Total Salary</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for salary in manager_salaries|slice:":5" %}
                            <tr>
                                <td>{{ salary.manager.user.name }}</td>
                                <td>{{ salary.days_worked }} days</td>
                                <td>&#8377;{{ salary.daily_rate }}</td>
                                <td><strong>&#8377;{{ salary.total_salary|floatformat:2 }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No compost managers found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </section>
</section>

<style>
    .dashboard-stat-card {
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s;
    }

    .dashboard-stat-card:hover {
        transform: translateY(-5px);
    }

    .dashboard-stat-card.bg-success {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important;
    }

    .dashboard-stat-card.bg-danger {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%) !important;
    }

    .dashboard-stat-card.bg-primary {
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%) !important;
    }

    .dashboard-stat-card.bg-warning {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%) !important;
    }
</style>
{% endblock %}